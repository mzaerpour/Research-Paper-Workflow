name: Auto-update Stage Folder link

on:
  workflow_dispatch:
  schedule:
    - cron: "* * * * *"   # every minute (fastest allowed)

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      PROJECT_OWNER: "mzaerpour"  # your username or org
      PROJECT_NUMBER: "3"         # from https://github.com/users/mzaerpour/projects/3

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Sync Stage → Stage Folder (force & verbose)
        env:
          GH_TOKEN: ${{ secrets.PROJECTS_TOKEN }}
          PROJECT_OWNER: ${{ env.PROJECT_OWNER }}
          PROJECT_NUMBER: ${{ env.PROJECT_NUMBER }}
        run: |
          python - <<'PY'
          import os, sys, requests

          token   = os.environ["GH_TOKEN"]
          owner   = os.environ["PROJECT_OWNER"]
          number  = int(os.environ["PROJECT_NUMBER"])

          H = {
              "Authorization": f"Bearer {token}",
              "Content-Type": "application/json",
              "Accept": "application/vnd.github+json",
          }
          GQL = "https://api.github.com/graphql"

          def gql(q, v):
              r = requests.post(GQL, headers=H, json={"query": q, "variables": v})
              r.raise_for_status()
              j = r.json()
              if "errors" in j:
                  print("GraphQL errors:", j["errors"], file=sys.stderr)
                  sys.exit(1)
              return j["data"]

          def get_project(mode="user"):
              q = '''
              query($owner:String!,$number:Int!){
                REPLACEME(login:$owner){
                  projectV2(number:$number){
                    id
                    fields(first:50){
                      nodes{
                        ... on ProjectV2SingleSelectField { id name options{ id name } }
                        ... on ProjectV2FieldCommon       { id name }
                      }
                    }
                  }
                }
              }'''.replace("REPLACEME", mode)
              d = gql(q, {"owner": owner, "number": number})
              return d["user" if mode=="user" else "organization"]["projectV2"]

          def get_items(mode="user", after=None):
              q = '''
              query($owner:String!,$number:Int!,$after:String){
                REPLACEME(login:$owner){
                  projectV2(number:$number){
                    items(first:100, after:$after){
                      nodes{
                        id
                        fieldValues(first:50){
                          nodes{
                            ... on ProjectV2ItemFieldSingleSelectValue{
                              field { ... on ProjectV2SingleSelectField { id name } }
                              name
                            }
                            ... on ProjectV2ItemFieldTextValue{
                              field { ... on ProjectV2FieldCommon { id name } }
                              text
                            }
                          }
                        }
                      }
                      pageInfo{ hasNextPage endCursor }
                    }
                  }
                }
              }'''.replace("REPLACEME", mode)
              d = gql(q, {"owner": owner, "number": number, "after": after})
              return d["user" if mode=="user" else "organization"]["projectV2"]["items"]

          # 1) get project + fields
          project = get_project("user") or get_project("organization")
          if not project:
              print("❌ Project not found. Check PROJECT_OWNER/PROJECT_NUMBER.")
              sys.exit(1)

          proj_id = project["id"]
          fields = project["fields"]["nodes"]

          stage_field_id = None
          stage_folder_field_id = None
          for f in fields:
              if f["name"] == "Stage":
                  stage_field_id = f["id"]
              if f["name"] == "Stage Folder":
                  stage_folder_field_id = f["id"]

          if not stage_field_id or not stage_folder_field_id:
              print("❌ Missing fields 'Stage' (single select) or 'Stage Folder' (text).")
              sys.exit(1)

          # 2) fetch all items
          all_items = []
          after = None
          mode = "user"
          # detect which mode worked
          try:
              # quick probe
              get_items("user")
          except:
              mode = "organization"
          while True:
              page = get_items(mode, after)
              all_items += page["nodes"]
              if page["pageInfo"]["hasNextPage"]:
                  after = page["pageInfo"]["endCursor"]
              else:
                  break

          base = "https://github.com/mzaerpour/Research-Paper-Workflow/tree/main"
          mapping = {
              "Conceptualization": f"{base}/docs/conceptualization",
              "Lit Review":        f"{base}/docs/lit_review",
              "Data":              f"{base}/data",
              "Analysis":          f"{base}/code",
              "Visualization":     f"{base}/figures",
              "Writing":           f"{base}/drafts",
              "Submission":        f"{base}/docs/submission",
              "Under Review":      f"{base}/docs/under_review",
              "Revision-1":        f"{base}/docs/revision_1",
              "Revision-2":        f"{base}/docs/revision_2",
              "Publication":       f"{base}/docs/publication",
          }

          update_mut = '''
          mutation($projectId:ID!, $itemId:ID!, $fieldId:ID!, $text:String!){
            updateProjectV2ItemFieldValue(input:{
              projectId:$projectId,
              itemId:$itemId,
              fieldId:$fieldId,
              value:{ text:$text }
            }){ projectV2Item { id } }
          }'''

          updated = 0
          for idx, item in enumerate(all_items, 1):
              stage_val = None
              current_text = None
              for fv in item.get("fieldValues", {}).get("nodes", []):
                  fld = fv.get("field")
                  if not fld: 
                      continue
                  if fld.get("name") == "Stage" and "name" in fv:
                      stage_val = fv["name"]
                  if fld.get("name") == "Stage Folder" and "text" in fv:
                      current_text = fv["text"]

              if not stage_val:
                  print(f"- Item {idx}: no Stage set → skipping")
                  continue

              target = mapping.get(stage_val)
              if not target:
                  fallback = f"{base}/docs"  # default if unknown Stage
                  print(f"- Item {idx}: Stage='{stage_val}' not in mapping → setting fallback: {fallback}")
                  target = fallback
              else:
                  print(f"- Item {idx}: Stage='{stage_val}' → Stage Folder='{target}'")

              # Force update every time so changes are visible immediately
              gql(update_mut, {
                  "projectId": proj_id,
                  "itemId": item["id"],
                  "fieldId": stage_folder_field_id,
                  "text": target
              })
              updated += 1

          print(f"✅ Updated {updated} item(s).")
          PY
